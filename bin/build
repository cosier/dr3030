#!/bin/bash

DIR="$( cd  "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
ROOT=$( cd $DIR/../ && pwd )

if [[ "$1" == "clean" ]]; then
  rm -rf $ROOT/build
fi

mkdir -p $ROOT/build && cd $ROOT/build;

if [[ "$RELEASE" == true ]]; then
  CMAKE_BUILD_TYPE=Release
elif [[ "$DEBUG" == true ]]; then
  CMAKE_BUILD_TYPE=Debug
fi

if [ -z "$CMAKE_BUILD_TYPE" ]; then
  CMAKE_BUILD_TYPE=Debug
fi

export BUILD_REVISION=$(git rev-parse --short --verify HEAD)
export BUILD_TIMESTAMP=$(date)

if [[ "$BUILD_REVISION" == "" ]]; then
  echo "Invalid Build Revision: $BUILD_REVISION"
  exit 1
fi

echo
echo -e " Building: $CMAKE_BUILD_TYPE"
echo -e " BUILD_TIMESTAMP: $BUILD_TIMESTAMP"
echo -e " BUILD_REVISION: $BUILD_REVISION "
echo -e "-------------------------------------\n"

if [[ ! -f $ROOT/build/Makefile ]]; then
  cmake \
    -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
    -DCMAKE_BUILD_TYPE=$CMAKE_BUILD_TYPE ..
  if [ ! $? -eq 0 ]; then
    exit 1
  fi
fi

make -j4
if [ ! $? -eq 0 ]; then
  echo "Make failed"
  exit 1
fi

echo

if [ ! -f $ROOT/bin/dimappio ]; then
  ln -sf $ROOT/build/src/mapper/dr3030 $ROOT/bin/dr3030
fi

